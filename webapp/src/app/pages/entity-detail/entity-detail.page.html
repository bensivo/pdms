<div class="entity-detail-container">
  <div class="page-header">
    <button nz-button nzType="text" (click)="onClickBackButton()">← All {{entity$()!.pluralName}}</button>
  </div>

  <div *ngIf="entity$() && record$()" class="entity-detail-content">
    <div class="detail-header">
      <h1>{{ entity$()!.name }}</h1>
      <div class="detail-actions">
        <ng-container *ngIf="!isEditMode()">
          <button nz-button nzType="primary" (click)="onClickEdit()">Edit</button>
        </ng-container>
        <ng-container *ngIf="isEditMode()">
          <button nz-button nzType="default" (click)="onClickCancelEdit()">Cancel</button>
          <button nz-button nzType="primary" (click)="onClickSave()">Save</button>
        </ng-container>
      </div>
    </div>

    <nz-card class="fields-card">
      <ng-container *ngFor="let field of entity$()!.fields">
        <div class="field-row" *ngIf="isEditMode() ? field.type !== 'backlink' : true">
          <div class="field-label">{{ field.name }}</div>
        <div class="field-value">
          <!-- View mode -->
          <ng-container *ngIf="!isEditMode()">
            <!-- Reference field: show as link -->
            <a *ngIf="field.type === 'reference' && getFieldValue(field.id)"
              [routerLink]="['/entity', getReferencedEntityRouteKey(field), getFieldValue(field.id)]">
              {{ getReferencedRecordDisplayName(field, getFieldValue(field.id)) }}
            </a>
            <span *ngIf="field.type === 'reference' && !getFieldValue(field.id)">—</span>
            <!-- Backlink field: show as list of links -->
            <div *ngIf="field.type === 'backlink'" class="backlink-list">
              <div *ngIf="getBacklinkedRecords(field).length === 0" class="empty-backlinks">No linked records</div>
              <a *ngFor="let backlinkRecord of getBacklinkedRecords(field)"
                [routerLink]="['/entity', getBacklinkSourceEntityRouteKey(field), backlinkRecord.id]"
                class="backlink-item">
                {{ entityRecordService.getRecordDisplayName(field.backlinkSourceEntityId!, backlinkRecord.id) }}
              </a>
            </div>
            <!-- Non-reference, non-backlink fields: show as text -->
            <span *ngIf="field.type !== 'reference' && field.type !== 'backlink'">
              {{ getFieldValue(field.id) || '—' }}
            </span>
          </ng-container>

          <!-- Edit mode: long-text gets textarea -->
          <textarea
            *ngIf="isEditMode() && field.type === 'long-text'"
            nz-input
            [nzAutosize]="{ minRows: 2, maxRows: 6 }"
            [ngModel]="getEditValue(field.id)"
            (ngModelChange)="setEditValue(field.id, $event)"
            [name]="field.id">
          </textarea>

          <!-- Edit mode: reference fields get select -->
          <nz-select *ngIf="isEditMode() && field.type === 'reference'"
            nzPlaceHolder="Select..."
            [ngModel]="getEditValue(field.id)"
            (ngModelChange)="setEditValue(field.id, $event)"
            [name]="field.id">
            <nz-option
              *ngFor="let opt of getReferencedRecordOptions(field)"
              [nzValue]="opt.value"
              [nzLabel]="opt.label">
            </nz-option>
          </nz-select>

          <!-- Edit mode: option fields get select -->
          <nz-select *ngIf="isEditMode() && field.type === 'option'"
            nzPlaceHolder="Select..."
            [ngModel]="getEditValue(field.id)"
            (ngModelChange)="setEditValue(field.id, $event)"
            [name]="field.id">
            <nz-option *ngFor="let val of field.optionValues" [nzValue]="val" [nzLabel]="val"></nz-option>
          </nz-select>

          <!-- Edit mode: all other types get a standard input -->
          <input
            *ngIf="isEditMode() && field.type !== 'long-text' && field.type !== 'reference' && field.type !== 'option'"
            nz-input
            [type]="field.type === 'number' ? 'number' : 'text'"
            [ngModel]="getEditValue(field.id)"
            (ngModelChange)="setEditValue(field.id, $event)"
            [name]="field.id" />
        </div>
        </div>
      </ng-container>
    </nz-card>
  </div>
</div>
