<div class="entity-detail-container">
  <div class="page-header">
    <button nz-button nzType="text" (click)="onClickBackButton()">← Back</button>
  </div>

  <div *ngIf="entity$()" class="entity-details">
    <h1>{{ entity$()!.name }}</h1>
    <p class="subtitle">{{ entity$()!.pluralName }}</p>

    <nz-card class="fields-card">
      <div class="section-header">
        <h2>Fields</h2>
        <button nz-button nzType="primary" (click)="onClickAddFieldButton()">
          + Add Field
        </button>
      </div>

      <div *ngIf="entity$()!.fields.length === 0" class="empty-state">
        <nz-empty nzNotFoundContent="No fields defined"></nz-empty>
      </div>

      <table *ngIf="entity$()!.fields.length > 0" class="fields-table">
        <thead>
          <tr>
            <th>Field Name</th>
            <th>Type</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let field of entity$()!.fields">
            <td>{{ field.name }}</td>
            <td>{{ getFieldTypeLabel(field.type) }}</td>
            <td>
              <button
                nz-button
                nzDanger
                nzType="text"
                nzSize="small"
                (click)="onClickRemoveFieldButton(field.id)">
                Remove
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="display-name-section" *ngIf="entity$()!.fields.length > 0">
        <div class="section-header">
          <h2>Display Name</h2>
        </div>
        <p class="hint-text">Choose the field to use when referencing this entity</p>
        <nz-select
          [ngModel]="entity$()!.displayNameFieldId"
          (ngModelChange)="onChangeDisplayNameField($event)"
          nzPlaceHolder="Select field (defaults to first field)"
          name="displayNameField">
          <nz-option *ngFor="let f of entity$()!.fields" [nzValue]="f.id" [nzLabel]="f.name"></nz-option>
        </nz-select>
      </div>
    </nz-card>
  </div>

  <!-- Add Field Modal -->
  <nz-modal
    [(nzVisible)]="showAddFieldModal"
    nzTitle="Add Field"
    (nzOnOk)="onClickConfirmAddFieldButton()"
    (nzOnCancel)="showAddFieldModal.set(false)">
    <ng-container *nzModalContent>
      <div class="modal-form">
        <div class="form-group">
          <label>Field Name</label>
          <input
            nz-input
            placeholder="e.g., First Name"
            [(ngModel)]="newFieldName"
            name="fieldName" />
        </div>

        <div class="form-group">
          <label>Field Type</label>
          <select
            nz-select
            [(ngModel)]="newFieldType"
            name="fieldType">
            <option
              *ngFor="let option of fieldTypeOptions"
              [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <div class="form-group" *ngIf="newFieldType === 'reference'">
          <label>References Entity</label>
          <nz-select [(ngModel)]="newFieldReferenceEntityId" nzPlaceHolder="Select entity" name="referenceEntity">
            <nz-option *ngFor="let e of referencableEntities$()" [nzValue]="e.id" [nzLabel]="e.pluralName"></nz-option>
          </nz-select>
        </div>

        <div class="form-group" *ngIf="newFieldType === 'backlink'">
          <label>Source Entity</label>
          <nz-select
            [ngModel]="newFieldBacklinkSourceEntityIdSignal()"
            (ngModelChange)="newFieldBacklinkSourceEntityIdSignal.set($event)"
            nzPlaceHolder="Select entity"
            name="backlinkSourceEntity">
            <nz-option *ngFor="let e of referencableEntities$()" [nzValue]="e.id" [nzLabel]="e.pluralName"></nz-option>
          </nz-select>
        </div>

        <div class="form-group" *ngIf="newFieldType === 'backlink'">
          <label>Source Field</label>
          <nz-select
            [ngModel]="newFieldBacklinkSourceFieldIdSignal()"
            (ngModelChange)="newFieldBacklinkSourceFieldIdSignal.set($event)"
            nzPlaceHolder="Select field"
            name="backlinkSourceField">
            <nz-option *ngFor="let f of backlinkSourceFields$()" [nzValue]="f.id" [nzLabel]="f.name"></nz-option>
          </nz-select>
        </div>

        <div class="form-group" *ngIf="newFieldType === 'option'">
          <label>Options</label>
          <div class="option-input-group">
            <input
              nz-input
              [(ngModel)]="newOptionInputValue"
              placeholder="Enter option value"
              (keyup.enter)="onClickAddOptionValue()"
              name="newOptionInput" />
            <button
              nz-button
              nzType="dashed"
              (click)="onClickAddOptionValue()"
              style="margin-left: 8px;">
              + Add
            </button>
          </div>
          <div class="option-tags" *ngIf="newFieldOptionValuesSignal().length > 0">
            <span
              *ngFor="let opt of newFieldOptionValuesSignal(); let i = index"
              class="option-tag">
              {{ opt }}
              <span
                class="option-tag-close"
                (click)="onClickRemoveOptionValue(i)"
                style="cursor: pointer; margin-left: 4px;">
                ×
              </span>
            </span>
          </div>
        </div>
      </div>
    </ng-container>
  </nz-modal>
</div>
