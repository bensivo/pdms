<div class="entity-list-container">
  <div *ngIf="entity$()" class="entity-list">
    <!-- Header -->
    <div class="list-header">
      <h1>{{ entity$()!.pluralName }}</h1>
      <button nz-button nzType="primary" nzSize="large" (click)="onClickNewButton()">+ New</button>
    </div>

    <!-- Toolbar -->
    <div class="list-toolbar">
      <input
        nz-input
        class="search-input"
        nzSize="large"
        placeholder="Search..."
        type="text"
        (input)="onFilterChange($event)"
        [value]="filterTextSignal()" />
      <button nz-button nzSize="large" (click)="onClickColumnsButton()">Columns</button>
    </div>

    <!-- Records Table -->
    <nz-table
      #recordTable
      [nzData]="filteredAndSortedRecords$()"
      [nzShowPagination]="filteredAndSortedRecords$().length > 20"
      nzSize="small"
      class="records-table">
      <thead>
        <tr>
          <th
            *ngFor="let field of visibleFields$()"
            (click)="onColumnHeaderClick(field.id)"
            class="sortable-header"
            [class.sorted]="sortFieldIdSignal() === field.id && sortOrderSignal() !== null">
            <span>{{ field.name }}</span>
            <span class="sort-indicator" *ngIf="sortFieldIdSignal() === field.id && sortOrderSignal() !== null">
              {{ sortOrderSignal() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let record of recordTable.data"
          class="record-row"
          (click)="onClickRecordRow(record.id)">
          <td *ngFor="let field of visibleFields$()">
            <a *ngIf="isReferenceField(field) && record.data[field.id]"
              [routerLink]="['/entity', getReferencedEntityRouteKey(field), record.data[field.id]]"
              (click)="$event.stopPropagation()">
              {{ getFieldDisplayValue(field, record) }}
            </a>
            <span *ngIf="!isReferenceField(field) || !record.data[field.id]">
              {{ getFieldDisplayValue(field, record) }}
            </span>
          </td>
        </tr>
      </tbody>
    </nz-table>

    <!-- Column Selection Modal -->
    <nz-modal
      [(nzVisible)]="isColumnModalOpenSignal"
      nzTitle="Select Columns"
      (nzOnOk)="onConfirmColumns()"
      (nzOnCancel)="onCancelColumns()">
      <ng-container *nzModalContent>
        <div class="column-checkbox-list">
          <div *ngFor="let field of entity$()!.fields" class="column-checkbox-item">
            <label nz-checkbox
              [nzChecked]="isPendingFieldVisible(field.id)"
              (nzCheckedChange)="onTogglePendingColumn(field.id, $event)">
              {{ field.name }}
            </label>
          </div>
        </div>
      </ng-container>
    </nz-modal>
  </div>
</div>
